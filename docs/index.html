<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Camera AI Car Speed Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.1.4"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a1120, #0f1b2e);
            color: #e0e1dd;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column; /* Allow content to stack */
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            width: 100%; /* Ensure container takes full width when visible */
        }

        /* Login Form Styles */
        .login-container {
            background: rgba(13, 27, 42, 0.9);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            border: 2px solid rgba(46, 139, 192, 0.4);
            text-align: center;
            width: 90%;
            max-width: 450px;
            margin: 50px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-container h2 {
            font-size: 2.2rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .login-input-group {
            text-align: left;
            margin-bottom: 15px;
        }

        .login-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #90e0ef;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .login-input-group input {
            width: 100%;
            padding: 14px 20px;
            border: none;
            background: rgba(10, 25, 40, 0.9);
            border-radius: 30px;
            color: #e0e1dd;
            font-size: 1.1rem;
            border: 2px solid rgba(46, 139, 192, 0.4);
            font-weight: 500;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .login-input-group input:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 0 4px rgba(76, 201, 240, 0.4);
        }

        .login-btn {
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            width: 100%;
        }

        .login-btn:hover {
            background: linear-gradient(90deg, #3a0ca3, #4361ee);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(58, 12, 163, 0.6);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        #loginMessage {
            color: #f72585;
            font-size: 1rem;
            margin-top: -10px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* Main Content Styles (from original code) */
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(46, 139, 192, 0.5);
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #90e0ef;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            margin-bottom: 30px;
        }

        .video-container {
            background: rgba(13, 27, 42, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(6px);
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(46, 139, 192, 0.4);
        }

        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(46, 139, 192, 0.3);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(25, 55, 80, 0.7);
            padding: 12px 20px;
            border-radius: 30px;
        }

        .btn {
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            background: linear-gradient(90deg, #3a0ca3, #4361ee);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(58, 12, 163, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.running {
            background: linear-gradient(90deg, #f72585, #b5179e);
        }

        .btn.recording {
            background: linear-gradient(90deg, #f72585, #d00000);
            animation: pulse 1.5s infinite;
        }

        #status {
            font-size: 1.1rem;
            color: #90e0ef;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(25, 55, 80, 0.6);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
        }

        #status.running {
            color: #4cc9f0;
            background: rgba(25, 55, 80, 0.8);
        }

        #status.alert {
            color: #f72585;
            animation: pulse 1.5s infinite;
            background: rgba(247, 37, 133, 0.2);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .canvas-wrapper {
            position: relative;
            background: #0a1929;
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6);
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio for 640x480 */
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }

        .recording-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(247, 37, 133, 0.4);
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 700;
            color: #ffafcc;
            z-index: 10;
            font-size: 1.1rem;
            border: 2px solid rgba(255, 175, 204, 0.3);
        }

        .recording-dot {
            width: 14px;
            height: 14px;
            background: #f72585;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .stats-panel {
            background: rgba(13, 27, 42, 0.8);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(6px);
            border: 2px solid rgba(46, 139, 192, 0.4);
        }

        .panel-title {
            font-size: 1.4rem;
            margin-bottom: 25px;
            color: #4cc9f0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(25, 55, 80, 0.7);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 2px solid rgba(46, 139, 192, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
            color: #90e0ef;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 1.1rem;
            color: #a8dadc;
            font-weight: 600;
        }

        .speed-control {
            background: rgba(10, 25, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid rgba(46, 139, 192, 0.4);
            position: relative;
        }

        .speed-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .speed-control-title {
            font-size: 1.1rem;
            color: #90e0ef;
            font-weight: 600;
        }

        .speed-control-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: #4cc9f0;
            background: rgba(0, 0, 0, 0.4);
            padding: 5px 20px;
            border-radius: 20px;
        }

        .speed-slider-container {
            padding: 0 10px;
        }

        .speed-slider {
            width: 100%;
            height: 12px;
            -webkit-appearance: none;
            background: rgba(76, 201, 240, 0.3);
            border-radius: 6px;
            outline: none;
            margin: 15px 0;
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #4cc9f0;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(76, 201, 240, 0.7);
            transition: all 0.2s;
            border: 2px solid white;
        }

        .speed-slider::-webkit-slider-thumb:hover {
            background: #3a86ff;
            transform: scale(1.15);
        }

        .speed-threshold {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #90e0ef;
            font-weight: 500;
        }

        .alert-container {
            background: rgba(247, 37, 133, 0.2);
            border: 2px solid rgba(247, 37, 133, 0.4);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .alert-title {
            color: #f72585;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 700;
        }

        .alert-count {
            font-size: 2.5rem;
            font-weight: 800;
            color: #f72585;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .alert-text {
            color: #ffafcc;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .sound-alerts {
            background: rgba(76, 201, 240, 0.2);
            border: 2px solid rgba(76, 201, 240, 0.4);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sound-title {
            color: #4cc9f0;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 700;
        }

        .sound-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(46, 139, 192, 0.2);
        }

        .sound-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .sound-info {
            flex: 1;
        }

        .sound-label {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .sound-desc {
            font-size: 0.95rem;
            color: #a8dadc;
        }

        .test-btn {
            background: rgba(76, 201, 240, 0.3);
            color: #4cc9f0;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 600;
        }

        .test-btn:hover {
            background: rgba(76, 201, 240, 0.5);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 500;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .normal {
            background: #4ade80;
        }

        .warning {
            background: #facc15;
        }

        .overspeed {
            background: #f87171;
        }

        .stationary {
            background: #a0aec0;
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .recording-list {
            margin-top: 20px;
            background: rgba(10, 25, 40, 0.9);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid rgba(46, 139, 192, 0.3);
        }

        .recording-item {
            padding: 12px;
            border-bottom: 2px solid rgba(46, 139, 192, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(25, 55, 80, 0.4);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .recording-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .recording-info {
            font-size: 1rem;
            font-weight: 500;
        }

        .download-btn {
            background: rgba(76, 201, 240, 0.3);
            color: #4cc9f0;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: 600;
        }

        .download-btn:hover {
            background: rgba(76, 201, 240, 0.5);
        }

        footer {
            text-align: center;
            padding: 30px 0 20px;
            color: #90e0ef;
            font-size: 1rem;
            border-top: 2px solid rgba(46, 139, 192, 0.4);
            margin-top: 20px;
        }

        .tech-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(25, 55, 80, 0.7);
            padding: 10px 18px;
            border-radius: 30px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            border: 1px solid rgba(46, 139, 192, 0.3);
        }

        .badge.new {
            background: rgba(247, 37, 133, 0.4);
            animation: pulse 2s infinite;
        }

        .performance-badge {
            background: rgba(76, 201, 240, 0.4);
            border: 1px solid rgba(76, 201, 240, 0.6);
        }

        /* Multi-camera controls */
        .camera-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(25, 55, 80, 0.7);
            padding: 15px;
            border-radius: 12px;
        }

        .camera-input-group {
            flex: 1;
            min-width: 300px;
        }

        .camera-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            background: rgba(10, 25, 40, 0.9);
            border-radius: 30px;
            color: #e0e1dd;
            font-size: 1rem;
            border: 2px solid rgba(46, 139, 192, 0.4);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .camera-input:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 0 4px rgba(76, 201, 240, 0.4);
        }

        .camera-label {
            display: block;
            margin-bottom: 8px;
            color: #90e0ef;
            font-weight: 600;
        }

        .camera-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .camera-tab {
            background: rgba(25, 55, 80, 0.7);
            color: #90e0ef;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .camera-tab:hover {
            background: rgba(46, 139, 192, 0.6);
        }

        .camera-tab.active {
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
            color: white;
        }

        .camera-stats {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 8px;
            z-index: 10;
            font-size: 0.9rem;
        }

        .camera-stat {
            color: #fff;
            margin: 3px 0;
        }

        .camera-stat span {
            color: #4cc9f0;
            font-weight: bold;
        }

        .performance-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 8px;
            z-index: 10;
            font-size: 0.9rem;
            color: #fff;
        }

        .performance-info span {
            color: #4cc9f0;
            font-weight: bold;
        }

        .traffic-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .traffic-low {
            background-color: #4ade80;
        }

        .traffic-medium {
            background-color: #facc15;
        }

        .traffic-high {
            background-color: #f87171;
        }

        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2.2rem;
            }

            .subtitle {
                font-size: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .camera-input-group {
                min-width: 100%;
            }
        }

        /* NEW: Speed settings control */
        .speed-settings-control {
            background: rgba(10, 25, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid rgba(46, 139, 192, 0.4);
            position: relative;
        }

        .speed-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .speed-settings-title {
            font-size: 1.1rem;
            color: #90e0ef;
            font-weight: 600;
        }

        .speed-settings-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: #4cc9f0;
            background: rgba(0, 0, 0, 0.4);
            padding: 5px 20px;
            border-radius: 20px;
        }

        .speed-settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .speed-setting-card {
            background: rgba(25, 55, 80, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s ease;
            border: 2px solid rgba(46, 139, 192, 0.3);
        }

        .speed-setting-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .speed-setting-label {
            font-size: 1rem;
            color: #a8dadc;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .speed-setting-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #90e0ef;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .speed-setting-slider-container {
            margin-top: 15px;
            padding: 0 10px;
        }

        .speed-setting-slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(76, 201, 240, 0.3);
            border-radius: 5px;
            outline: none;
            margin: 10px 0;
        }

        .speed-setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #4cc9f0;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.7);
            transition: all 0.2s;
            border: 2px solid white;
        }

        .speed-setting-slider::-webkit-slider-thumb:hover {
            background: #3a86ff;
            transform: scale(1.15);
        }

        .speed-setting-threshold {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            color: #90e0ef;
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Performance settings cards proportional sizes */
        .performance-card {
            background: rgba(25, 55, 80, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid rgba(46, 139, 192, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 60px; /* Base height */
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .performance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #4361ee, #3a0ca3);
        }

        .performance-card.high {
            height: 60px;
            background: rgba(25, 55, 80, 0.8);
            box-shadow: 0 8px 25px rgba(76, 201, 240, 0.3);
        }

        .performance-card.medium {
            height: 45px;
        }

        .performance-card.low {
            height: 30px;
        }

        .performance-card .value {
            font-size: 1.4rem;
            font-weight: 800;
            color: #90e0ef;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        .performance-card .label {
            font-size: 1rem;
            color: #a8dadc;
            font-weight: 600;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .performance-title {
            font-size: 1.1rem;
            color: #90e0ef;
            font-weight: 600;
        }

        .performance-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: #4cc9f0;
            background: rgba(0, 0, 0, 0.4);
            padding: 5px 20px;
            border-radius: 20px;
        }

        .performance-section {
            background: rgba(10, 25, 40, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid rgba(46, 139, 192, 0.4);
        }

        /* URL type indicator */
        .url-type {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #90e0ef;
            z-index: 10;
        }

        /* Logout Button */
        .logout-btn {
            background: linear-gradient(90deg, #f72585, #b5179e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
            display: block; /* Make it a block element to center with margin auto */
            margin-left: auto;
            margin-right: auto;
        }

        .logout-btn:hover {
            background: linear-gradient(90deg, #b5179e, #f72585);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(247, 37, 133, 0.5);
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <h2>Login to System</h2>
        <form id="loginForm">
            <div class="login-input-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter username" required>
            </div>
            <div class="login-input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter password" required>
            </div>
            <p id="loginMessage" style="display: none;">Invalid username or password.</p>
            <button type="submit" class="login-btn">Login</button>
        </form>
    </div>

    <!-- Main Content Container - Initially hidden -->
    <div class="container" id="mainContent" style="display: none;">
        <header>
            <h1>Multi-Camera AI Car Speed Detection</h1>
            <p class="subtitle">Universal URL support for RTSP, RTMP, HLS, MJPEG, and WebRTC streams</p>
        </header>

        <!-- Camera URL inputs -->
        <div class="camera-controls">
            <div class="camera-input-group">
                <label class="camera-label">Camera 1 URL</label>
                <input type="text" class="camera-input" id="camUrl1" placeholder="Enter Stream URL" value="http://192.168.1.6:8080/video">
            </div>
            <div class="camera-input-group">
                <label class="camera-label">Camera 2 URL</label>
                <input type="text" class="camera-input" id="camUrl2" placeholder="Enter Stream URL" value="http://192.168.1.7:8080/video">
            </div>
            <div class="camera-input-group">
                <label class="camera-label">Camera 3 URL</label>
                <input type="text" class="camera-input" id="camUrl3" placeholder="Enter Stream URL" value="http://192.168.1.8:8080/video">
            </div>
            <div class="camera-input-group">
                <label class="camera-label">Camera 4 URL</label>
                <input type="text" class="camera-input" id="camUrl4" placeholder="Enter Stream URL" value="http://192.168.1.9:8080/video">
            </div>
            <div class="camera-input-group">
                <label class="camera-label">Camera 5 URL</label>
                <input type="text" class="camera-input" id="camUrl5" placeholder="Enter Stream URL" value="http://192.168.1.10:8080/video">
            </div>
            <div class="camera-input-group">
                <label class="camera-label">Camera 6 URL</label>
                <input type="text" class="camera-input" id="camUrl6" placeholder="Enter Stream URL" value="http://192.168.1.11:8080/video">
            </div>
        </div>

        <div class="dashboard">
            <div class="video-container">
                <div class="video-header">
                    <div class="controls">
                        <button id="toggleAllBtn" class="btn">
                            <span>Start All Cameras</span>
                        </button>
                        <button id="recordBtn" class="btn">
                            <span>Start Recording</span>
                        </button>
                    </div>
                    <div id="status">?? System Ready</div>
                </div>

                <!-- Camera tabs -->
                <div class="camera-tabs">
                    <button class="camera-tab active" data-camera="1">Camera 1</button>
                    <button class="camera-tab" data-camera="2">Camera 2</button>
                    <button class="camera-tab" data-camera="3">Camera 3</button>
                    <button class="camera-tab" data-camera="4">Camera 4</button>
                    <button class="camera-tab" data-camera="5">Camera 5</button>
                    <button class="camera-tab" data-camera="6">Camera 6</button>
                </div>

                <!-- Canvas for active camera -->
                <div class="canvas-wrapper">
                    <canvas id="canvas" width="640" height="480"></canvas>
                    <div id="recIndicator" class="recording-indicator" style="display:none;">
                        <div class="recording-dot"></div>
                        <span>RECORDING</span>
                    </div>
                    <div class="camera-stats" id="cameraStats">
                        <div class="camera-stat">Vehicles: <span id="camVehicleCount">0</span></div>
                        <div class="camera-stat">Max Speed: <span id="camMaxSpeed">0</span> km/h</div>
                        <div class="camera-stat">FPS: <span id="camFps">0</span></div>
                    </div>
                    <div class="performance-info" id="performanceInfo">
                        Traffic: <span id="trafficLevel">Low</span> <span class="traffic-indicator traffic-low" id="trafficIndicator"></span>
                    </div>
                    <div class="url-type" id="urlTypeIndicator">URL Type: MJPEG</div>
                </div>
            </div>

            <div class="stats-panel">
                <h2 class="panel-title">?? Detection Statistics</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="vehicleCount">0</div>
                        <div class="stat-label">Vehicles Detected</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="maxSpeed">0</div>
                        <div class="stat-label">Max Speed (km/h)</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="avgSpeed">0</div>
                        <div class="stat-label">Avg Speed (km/h)</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-value" id="detectionFps">0</div>
                        <div class="stat-label">Detection FPS</div>
                    </div>
                </div>

                <!-- NEW: Speed Settings Control -->
                <div class="speed-settings-control">
                    <div class="speed-settings-header">
                        <div class="speed-settings-title">Speed Settings</div>
                        <div class="speed-settings-value" id="speedSettingsValue">Active</div>
                    </div>

                    <div class="speed-settings-grid">
                        <div class="speed-setting-card">
                            <div class="speed-setting-label">Speed Threshold</div>
                            <div class="speed-setting-value" id="speedThresholdValue">1 km/h</div>
                            <div class="speed-setting-slider-container">
                                <input type="range" min="1" max="200" step="1" value="1" class="speed-setting-slider" id="speedThresholdSlider">
                                <div class="speed-setting-threshold">
                                    <span>1 km/h</span>
                                    <span>200 km/h</span>
                                </div>
                            </div>
                        </div>

                        <div class="speed-setting-card">
                            <div class="speed-setting-label">Speed Limit</div>
                            <div class="speed-setting-value" id="speedLimitValue">120 km/h</div>
                            <div class="speed-setting-slider-container">
                                <input type="range" min="1" max="200" step="1" value="1" class="speed-setting-slider" id="speedLimitSlider">
                                <div class="speed-setting-threshold">
                                    <span>1 km/h</span>
                                    <span>200 km/h</span>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Settings Panel -->
                <div class="performance-section">
                    <div class="performance-header">
                        <div class="performance-title">Performance Settings</div>
                        <div class="performance-value" id="performanceValue">Auto</div>
                    </div>

                    <div class="performance-grid">
                        <div class="performance-card high">
                            <div class="value">30-60</div>
                            <div class="label">Target FPS</div>
                        </div>
                        <div class="performance-card high">
                            <div class="value">High</div>
                            <div class="label">Resolution</div>
                        </div>
                        <div class="performance-card medium">
                            <div class="value">20-30</div>
                            <div class="label">Target FPS</div>
                        </div>
                        <div class="performance-card medium">
                            <div class="value">Medium</div>
                            <div class="label">Resolution</div>
                        </div>
                        <div class="performance-card low">
                            <div class="value">15-20</div>
                            <div class="label">Target FPS</div>
                        </div>
                        <div class="performance-card low">
                            <div class="value">Low</div>
                            <div class="label">Resolution</div>
                        </div>
                    </div>
                </div>

                <div class="alert-container">
                    <div class="alert-title">?? Over-speed Alerts</div>
                    <div class="alert-count" id="overSpeedCount">0</div>
                    <p class="alert-text">Vehicles detected exceeding the speed limit</p>
                </div>

                <div class="sound-alerts">
                    <div class="sound-title">?? Sound Alerts</div>
                    <div class="sound-item">
                        <div class="sound-color normal"></div>
                        <div class="sound-info">
                            <div class="sound-label">Normal Speed Alert</div>
                            <div class="sound-desc">Played when vehicles are within limit</div>
                        </div>
                        <button class="test-btn" data-sound="normal">Test</button>
                    </div>
                    <div class="sound-item">
                        <div class="sound-color warning"></div>
                        <div class="sound-info">
                            <div class="sound-label">Warning Alert</div>
                            <div class="sound-desc">Played when approaching speed limit</div>
                        </div>
                        <button class="test-btn" data-sound="warning">Test</button>
                    </div>
                    <div class="sound-item">
                        <div class="sound-color overspeed"></div>
                        <div class="sound-info">
                            <div class="sound-label">Over Speed Alert</div>
                            <div class="sound-desc">Played when exceeding speed limit</div>
                        </div>
                        <button class="test-btn" data-sound="overspeed">Test</button>
                    </div>
                    <div class="sound-item">
                        <div class="sound-color stationary"></div>
                        <div class="sound-info">
                            <div class="sound-label">Stationary Vehicle</div>
                            <div class="sound-desc">Ignored in speed calculations</div>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color normal"></div>
                        <span>Normal Speed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color warning"></div>
                        <span>Warning Zone</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color overspeed"></div>
                        <span>Over Speed</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color stationary"></div>
                        <span>Stationary</span>
                    </div>
                </div>

                <h2 class="panel-title" style="margin-top: 30px;">?? Recordings</h2>

                <div class="recording-controls">
                    <button id="saveBtn" class="btn" disabled>Save Recording</button>
                    <button id="downloadBtn" class="btn" disabled>Download</button>
                </div>

                <div class="recording-list" id="recordingList">
                    <div class="recording-item">
                        <div class="recording-info">No recordings yet</div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Multi-Camera Vehicle Speed Detection System | Powered by Raji Technology</p>
            <div class="tech-badges">
                <div class="badge performance-badge">Universal URL Support</div>
                <div class="badge">6 Camera Support</div>
                <div class="badge">Dynamic FPS/Resolution</div>
                <div class="badge">TensorFlow.js</div>
                <div class="badge new">RTSP/RTMP/HLS</div>
            </div>
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </footer>
    </div>

    <!-- Hidden elements for each camera -->
    <div style="display: none;">
        <img id="mjpeg1" crossorigin="anonymous">
        <img id="mjpeg2" crossorigin="anonymous">
        <img id="mjpeg3" crossorigin="anonymous">
        <img id="mjpeg4" crossorigin="anonymous">
        <img id="mjpeg5" crossorigin="anonymous">
        <img id="mjpeg6" crossorigin="anonymous">

        <!-- Video elements for other stream types -->
        <video id="video1" autoplay playsinline muted crossorigin="anonymous"></video>
        <video id="video2" autoplay playsinline muted crossorigin="anonymous"></video>
        <video id="video3" autoplay playsinline muted crossorigin="anonymous"></video>
        <video id="video4" autoplay playsinline muted crossorigin="anonymous"></video>
        <video id="video5" autoplay playsinline muted crossorigin="anonymous"></video>
        <video id="video6" autoplay playsinline muted crossorigin="anonymous"></video>
    </div>

    <script>
        // --- Login Logic ---
        const loginContainer = document.getElementById('loginContainer');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('loginMessage');
        const mainContent = document.getElementById('mainContent');
        const logoutBtn = document.getElementById('logoutBtn');

        // Hardcoded credentials for demonstration
        const VALID_USERNAME = 'user';
        const VALID_PASSWORD = 'password';
        const LOGIN_KEY = 'isLoggedIn';

        /**
         * Shows the main application content and hides the login form.
         */
        function showMainContent() {
            loginContainer.style.display = 'none';
            mainContent.style.display = 'block'; // Or 'flex', 'grid' depending on your main container's display
            document.body.style.justifyContent = 'flex-start'; // Reset body alignment
            document.body.style.alignItems = 'flex-start';
        }

        /**
         * Shows the login form and hides the main application content.
         */
        function showLoginForm() {
            loginContainer.style.display = 'flex'; // Use flex for centering login form
            mainContent.style.display = 'none';
            document.body.style.justifyContent = 'center'; // Center login form
            document.body.style.alignItems = 'center';
            loginMessage.style.display = 'none'; // Hide any previous login messages
            usernameInput.value = '';
            passwordInput.value = '';
        }

        /**
         * Handles the login form submission.
         * @param {Event} event - The form submission event.
         */
        loginForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent default form submission

            const username = usernameInput.value;
            const password = passwordInput.value;

            if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                sessionStorage.setItem(LOGIN_KEY, 'true'); // Store login status
                showMainContent();
            } else {
                loginMessage.style.display = 'block'; // Show error message
            }
        });

        /**
         * Handles the logout button click.
         */
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem(LOGIN_KEY); // Clear login status
            showLoginForm();
        });

        // Check login status on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem(LOGIN_KEY) === 'true') {
                showMainContent();
            } else {
                showLoginForm();
            }
        });

        // --- Original AI Car Speed Detection Script (start below this line) ---
        // This part of the script remains largely unchanged, but now runs only after login.

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const toggleAllBtn = document.getElementById('toggleAllBtn');
        const recordBtn = document.getElementById('recordBtn');
        const recIndicator = document.getElementById('recIndicator');
        const vehicleCountSpan = document.getElementById('vehicleCount');
        const maxSpeedSpan = document.getElementById('maxSpeed');
        const avgSpeedSpan = document.getElementById('avgSpeed');
        const detectionFpsSpan = document.getElementById('detectionFps');
        const overSpeedCountSpan = document.getElementById('overSpeedCount');
        const speedThresholdSlider = document.getElementById('speedThresholdSlider');
        const speedThresholdValue = document.getElementById('speedThresholdValue');
        const speedLimitSlider = document.getElementById('speedLimitSlider');
        const speedLimitValue = document.getElementById('speedLimitValue');
        const saveBtn = document.getElementById('saveBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const recordingList = document.getElementById('recordingList');
        const urlTypeIndicator = document.getElementById('urlTypeIndicator');
        const performanceInfo = document.getElementById('performanceInfo');
        const trafficLevelSpan = document.getElementById('trafficLevel');
        const trafficIndicator = document.getElementById('trafficIndicator');
        const camVehicleCountSpan = document.getElementById('camVehicleCount');
        const camMaxSpeedSpan = document.getElementById('camMaxSpeed');
        const camFpsSpan = document.getElementById('camFps');

        // Camera URL inputs and tabs
        const cameraUrls = [
            document.getElementById('camUrl1'),
            document.getElementById('camUrl2'),
            document.getElementById('camUrl3'),
            document.getElementById('camUrl4'),
            document.getElementById('camUrl5'),
            document.getElementById('camUrl6')
        ];
        const cameraTabs = document.querySelectorAll('.camera-tab');

        // Hidden video/image elements
        const mjpegImgs = [
            document.getElementById('mjpeg1'),
            document.getElementById('mjpeg2'),
            document.getElementById('mjpeg3'),
            document.getElementById('mjpeg4'),
            document.getElementById('mjpeg5'),
            document.getElementById('mjpeg6')
        ];
        const videoElements = [
            document.getElementById('video1'),
            document.getElementById('video2'),
            document.getElementById('video3'),
            document.getElementById('video4'),
            document.getElementById('video5'),
            document.getElementById('video6')
        ];

        let model;
        let animationFrameId;
        let isRunning = false;
        let mediaRecorder;
        let recordedChunks = [];
        let activeCameraIndex = 0; // 0-indexed for array access
        let hlsInstances = []; // To store HLS.js instances

        const vehicleTracking = new Map(); // Stores {id: {lastPosition, lastTimestamp, speeds: []}}
        let totalVehiclesDetected = 0;
        let totalSpeedSum = 0;
        let totalSpeedCount = 0;
        let overSpeedCount = 0;
        let lastFrameTime = performance.now();
        let frameCount = 0;

        // Sound effects using Tone.js (if needed, add Tone.js script tag)
        // For now, simple Audio objects
        const sounds = {
            normal: new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'),
            warning: new Audio('https://www.soundjay.com/buttons/beep-07.mp3'),
            overspeed: new Audio('https://www.soundjay.com/buttons/beep-08a.mp3')
        };

        // Initialize sliders
        speedThresholdSlider.value = 50; // Default threshold
        speedLimitSlider.value = 120; // Default limit

        speedThresholdValue.textContent = `${speedThresholdSlider.value} km/h`;
        speedLimitValue.textContent = `${speedLimitSlider.value} km/h`;

        /**
         * Loads the COCO-SSD object detection model.
         */
        async function loadModel() {
            statusDiv.textContent = '?? Loading AI Model...';
            statusDiv.classList.remove('running', 'alert');
            try {
                model = await cocoSsd.load();
                statusDiv.textContent = '?? Model Loaded. System Ready.';
                statusDiv.classList.add('running');
                toggleAllBtn.disabled = false;
            } catch (error) {
                console.error('Failed to load model:', error);
                statusDiv.textContent = '?? Error loading model.';
                statusDiv.classList.add('alert');
            }
        }

        /**
         * Determines the type of URL (MJPEG, HLS, or other video).
         * @param {string} url The URL to check.
         * @returns {string} The detected URL type.
         */
        function getUrlType(url) {
            if (!url) return 'Unknown';
            if (url.toLowerCase().endsWith('.mjpeg') || url.toLowerCase().includes('mjpeg')) {
                return 'MJPEG';
            }
            if (url.toLowerCase().endsWith('.m3u8')) {
                return 'HLS';
            }
            // Add more checks for RTSP, RTMP if you have a proxy or specific library
            // For now, treat everything else as generic video
            return 'Video';
        }

        /**
         * Initializes the video stream for a given camera index.
         * @param {number} camIdx - The 0-indexed camera number.
         * @param {string} url - The stream URL.
         */
        function initializeVideoStream(camIdx, url) {
            const currentVideoElement = videoElements[camIdx];
            const currentMjpegImg = mjpegImgs[camIdx];
            const urlType = getUrlType(url);

            // Clear previous sources/HLS instances
            if (hlsInstances[camIdx]) {
                hlsInstances[camIdx].destroy();
                hlsInstances[camIdx] = null;
            }
            currentVideoElement.src = '';
            currentMjpegImg.src = '';
            currentVideoElement.style.display = 'none';
            currentMjpegImg.style.display = 'none';

            if (urlType === 'MJPEG') {
                currentMjpegImg.src = url;
                currentMjpegImg.style.display = 'block';
                console.log(`Camera ${camIdx + 1}: Initialized as MJPEG stream.`);
            } else if (urlType === 'HLS') {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(currentVideoElement);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        currentVideoElement.play();
                    });
                    hlsInstances[camIdx] = hls;
                    currentVideoElement.style.display = 'block';
                    console.log(`Camera ${camIdx + 1}: Initialized as HLS stream.`);
                } else if (currentVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    currentVideoElement.src = url;
                    currentVideoElement.addEventListener('loadedmetadata', function() {
                        currentVideoElement.play();
                    });
                    currentVideoElement.style.display = 'block';
                    console.log(`Camera ${camIdx + 1}: Initialized as native HLS stream.`);
                } else {
                    console.error(`Camera ${camIdx + 1}: HLS is not supported in this browser.`);
                    statusDiv.textContent = `?? HLS not supported for Camera ${camIdx + 1}.`;
                    statusDiv.classList.add('alert');
                }
            } else { // Generic video (WebRTC, RTMP, RTSP via proxy, etc.)
                currentVideoElement.src = url;
                currentVideoElement.addEventListener('loadedmetadata', function() {
                    currentVideoElement.play();
                });
                currentVideoElement.style.display = 'block';
                console.log(`Camera ${camIdx + 1}: Initialized as generic video stream.`);
            }

            // Update URL type indicator for the currently active camera
            if (camIdx === activeCameraIndex) {
                urlTypeIndicator.textContent = `URL Type: ${urlType}`;
            }
        }

        /**
         * Switches the active camera displayed on the canvas.
         * @param {number} newCamIndex - The 0-indexed camera number to switch to.
         */
        function switchCamera(newCamIndex) {
            if (newCamIndex < 0 || newCamIndex >= cameraUrls.length) {
                console.error('Invalid camera index:', newCamIndex);
                return;
            }

            activeCameraIndex = newCamIndex;

            // Update active tab styling
            cameraTabs.forEach((tab, index) => {
                if (index === newCamIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update URL type indicator for the new camera
            const activeUrl = cameraUrls[activeCameraIndex].value;
            urlTypeIndicator.textContent = `URL Type: ${getUrlType(activeUrl)}`;

            // Reset stats for the new camera view
            camVehicleCountSpan.textContent = '0';
            camMaxSpeedSpan.textContent = '0';
            camFpsSpan.textContent = '0';
        }

        /**
         * Detects objects in the current frame and draws bounding boxes.
         * @param {HTMLVideoElement|HTMLImageElement} mediaSource - The video or image element.
         */
        async function detectObjects(mediaSource) {
            if (!model || !isRunning || !mediaSource || mediaSource.readyState < 2 && mediaSource.tagName === 'VIDEO') {
                animationFrameId = requestAnimationFrame(() => detectObjects(mediaSource));
                return;
            }

            const currentTimestamp = performance.now();
            const elapsedTime = (currentTimestamp - lastFrameTime) / 1000; // in seconds
            lastFrameTime = currentTimestamp;
            frameCount++;

            // Calculate overall FPS
            const overallFps = frameCount / (currentTimestamp / 1000);
            detectionFpsSpan.textContent = overallFps.toFixed(1);

            // Update camera-specific FPS
            camFpsSpan.textContent = (1 / elapsedTime).toFixed(1);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mediaSource, 0, 0, canvas.width, canvas.height);

            const predictions = await model.detect(canvas);

            let currentFrameMaxSpeed = 0;
            let currentFrameVehicleCount = 0;
            let currentFrameTrafficLevel = 'Low';

            predictions.forEach(prediction => {
                if (prediction.class === 'car' || prediction.class === 'truck' || prediction.class === 'bus') {
                    currentFrameVehicleCount++;
                    const [x, y, width, height] = prediction.bbox;
                    const centerX = x + width / 2;
                    const centerY = y + height / 2;

                    const id = prediction.class + '-' + Math.floor(centerX / 50) + '-' + Math.floor(centerY / 50); // Simple ID based on position

                    if (!vehicleTracking.has(id)) {
                        vehicleTracking.set(id, {
                            lastPosition: { centerX, centerY },
                            lastTimestamp: currentTimestamp,
                            speeds: [],
                            lastSpeed: 0,
                            isStationary: false,
                            stationaryStartTime: null
                        });
                        totalVehiclesDetected++;
                    } else {
                        const trackedVehicle = vehicleTracking.get(id);
                        const distance = Math.sqrt(
                            Math.pow(centerX - trackedVehicle.lastPosition.centerX, 2) +
                            Math.pow(centerY - trackedVehicle.lastPosition.centerY, 2)
                        );
                        const timeDiff = (currentTimestamp - trackedVehicle.lastTimestamp) / 1000; // seconds

                        let speed = 0;
                        if (timeDiff > 0) {
                            // Convert pixels/second to km/h. This is a placeholder; needs calibration.
                            // Assuming 1 pixel = 0.1 meters for a rough estimate.
                            const PIXELS_TO_KM_PER_HOUR = 0.1 * 3.6; // 0.1m/pixel * 3600s/h / 1000m/km
                            speed = (distance / timeDiff) * PIXELS_TO_KM_PER_HOUR;
                        }

                        // Check for stationary vehicle
                        const movementThreshold = 5; // pixels
                        if (distance < movementThreshold) {
                            if (!trackedVehicle.isStationary) {
                                trackedVehicle.stationaryStartTime = currentTimestamp;
                                trackedVehicle.isStationary = true;
                            }
                            // If stationary for a while, consider speed 0
                            if ((currentTimestamp - trackedVehicle.stationaryStartTime) / 1000 > 1) { // 1 second stationary
                                speed = 0;
                            }
                        } else {
                            trackedVehicle.isStationary = false;
                            trackedVehicle.stationaryStartTime = null;
                        }

                        trackedVehicle.lastPosition = { centerX, centerY };
                        trackedVehicle.lastTimestamp = currentTimestamp;
                        trackedVehicle.lastSpeed = speed;

                        // Only add non-zero speeds for average calculation
                        if (speed > 0) {
                            trackedVehicle.speeds.push(speed);
                            totalSpeedSum += speed;
                            totalSpeedCount++;
                        }

                        if (speed > currentFrameMaxSpeed) {
                            currentFrameMaxSpeed = speed;
                        }

                        // Draw bounding box and speed
                        ctx.beginPath();
                        ctx.rect(x, y, width, height);
                        ctx.lineWidth = 2;
                        ctx.font = '16px Arial';
                        ctx.fillStyle = 'white';
                        ctx.strokeStyle = 'white';

                        let speedStatus = 'normal';
                        if (speed > speedLimitSlider.value) {
                            ctx.strokeStyle = '#f87171'; // Red for overspeed
                            speedStatus = 'overspeed';
                            overSpeedCount++;
                            sounds.overspeed.play().catch(e => console.error("Sound play error:", e));
                        } else if (speed > speedLimitSlider.value * 0.8 && speed <= speedLimitSlider.value) {
                            ctx.strokeStyle = '#facc15'; // Yellow for warning
                            speedStatus = 'warning';
                            sounds.warning.play().catch(e => console.error("Sound play error:", e));
                        } else if (speed === 0 && trackedVehicle.isStationary) {
                            ctx.strokeStyle = '#a0aec0'; // Grey for stationary
                            speedStatus = 'stationary';
                        } else {
                            ctx.strokeStyle = '#4ade80'; // Green for normal
                            sounds.normal.play().catch(e => console.error("Sound play error:", e));
                        }
                        ctx.stroke();

                        ctx.fillText(
                            `${prediction.class} ${speed.toFixed(1)} km/h`,
                            x,
                            y > 10 ? y - 10 : 10
                        );
                    }
                }
            });

            // Update overall stats
            vehicleCountSpan.textContent = totalVehiclesDetected;
            maxSpeedSpan.textContent = totalSpeedCount > 0 ? (totalSpeedSum / totalSpeedCount).toFixed(1) : '0';
            avgSpeedSpan.textContent = totalSpeedCount > 0 ? (totalSpeedSum / totalSpeedCount).toFixed(1) : '0';
            overSpeedCountSpan.textContent = overSpeedCount;

            // Update camera-specific stats
            camVehicleCountSpan.textContent = currentFrameVehicleCount;
            camMaxSpeedSpan.textContent = currentFrameMaxSpeed.toFixed(1);

            // Update traffic level indicator
            if (currentFrameVehicleCount > 10) {
                currentFrameTrafficLevel = 'High';
                trafficIndicator.className = 'traffic-indicator traffic-high';
            } else if (currentFrameVehicleCount > 5) {
                currentFrameTrafficLevel = 'Medium';
                trafficIndicator.className = 'traffic-indicator traffic-medium';
            } else {
                currentFrameTrafficLevel = 'Low';
                trafficIndicator.className = 'traffic-indicator traffic-low';
            }
            trafficLevelSpan.textContent = currentFrameTrafficLevel;


            animationFrameId = requestAnimationFrame(() => detectObjects(mediaSource));
        }

        /**
         * Starts or stops the detection process for all cameras.
         */
        async function toggleAllCameras() {
            isRunning = !isRunning;
            if (isRunning) {
                statusDiv.textContent = '?? Starting detection...';
                statusDiv.classList.add('running');
                toggleAllBtn.classList.add('running');
                toggleAllBtn.querySelector('span').textContent = 'Stop All Cameras';

                // Initialize all camera streams
                cameraUrls.forEach((input, index) => {
                    if (input.value) {
                        initializeVideoStream(index, input.value);
                    }
                });

                // Start detection on the currently active camera's media source
                const activeMediaSource = getActiveMediaSource();
                if (activeMediaSource) {
                    animationFrameId = requestAnimationFrame(() => detectObjects(activeMediaSource));
                } else {
                    console.warn('No active media source to start detection.');
                    statusDiv.textContent = '?? No active camera stream.';
                    statusDiv.classList.add('alert');
                    isRunning = false; // Revert state
                    toggleAllBtn.classList.remove('running');
                    toggleAllBtn.querySelector('span').textContent = 'Start All Cameras';
                }

            } else {
                statusDiv.textContent = '?? System Paused.';
                statusDiv.classList.remove('running');
                toggleAllBtn.classList.remove('running');
                toggleAllBtn.querySelector('span').textContent = 'Start All Cameras';
                cancelAnimationFrame(animationFrameId);

                // Stop all HLS instances
                hlsInstances.forEach(hls => hls && hls.destroy());
                hlsInstances = [];

                // Stop all video elements
                videoElements.forEach(video => {
                    video.pause();
                    video.src = '';
                    video.load(); // Reset video element
                });
                // Stop all MJPEG images
                mjpegImgs.forEach(img => {
                    img.src = '';
                });
            }
        }

        /**
         * Gets the currently active video or image element.
         * @returns {HTMLVideoElement|HTMLImageElement|null} The active media element.
         */
        function getActiveMediaSource() {
            const activeUrl = cameraUrls[activeCameraIndex].value;
            const urlType = getUrlType(activeUrl);

            if (urlType === 'MJPEG') {
                return mjpegImgs[activeCameraIndex];
            } else if (urlType === 'HLS' || urlType === 'Video') {
                return videoElements[activeCameraIndex];
            }
            return null;
        }

        /**
         * Starts or stops recording the canvas output.
         */
        function toggleRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.classList.remove('recording');
                recordBtn.querySelector('span').textContent = 'Start Recording';
                recIndicator.style.display = 'none';
                saveBtn.disabled = false;
                downloadBtn.disabled = false;
            } else {
                recordedChunks = [];
                const stream = canvas.captureStream();
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);

                    const recordingItem = document.createElement('div');
                    recordingItem.classList.add('recording-item');
                    recordingItem.innerHTML = `
                        <div class="recording-info">Recording ${new Date().toLocaleString()}</div>
                        <button class="download-btn" data-url="${url}" data-filename="recording-${Date.now()}.webm">Download</button>
                    `;
                    // Prepend to show newest recordings first
                    if (recordingList.firstChild && recordingList.firstChild.classList.contains('recording-item')) {
                        recordingList.insertBefore(recordingItem, recordingList.firstChild);
                    } else {
                        recordingList.innerHTML = ''; // Clear "No recordings yet"
                        recordingList.appendChild(recordingItem);
                    }

                    // Add event listener for the newly created download button
                    recordingItem.querySelector('.download-btn').addEventListener('click', (e) => {
                        const downloadUrl = e.target.dataset.url;
                        const filename = e.target.dataset.filename;
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadUrl); // Clean up
                    });
                };

                mediaRecorder.start();
                recordBtn.classList.add('recording');
                recordBtn.querySelector('span').textContent = 'Stop Recording';
                recIndicator.style.display = 'flex';
                saveBtn.disabled = true; // Disable save/download while recording
                downloadBtn.disabled = true;
            }
        }

        /**
         * Plays a test sound.
         * @param {string} soundType - 'normal', 'warning', or 'overspeed'.
         */
        function playTestSound(soundType) {
            if (sounds[soundType]) {
                sounds[soundType].play().catch(e => console.error("Sound play error:", e));
            }
        }

        // Event Listeners
        toggleAllBtn.addEventListener('click', toggleAllCameras);
        recordBtn.addEventListener('click', toggleRecording);

        // Camera tab click listeners
        cameraTabs.forEach((tab, index) => {
            tab.addEventListener('click', () => {
                switchCamera(index);
                // If running, restart detection for the new camera
                if (isRunning) {
                    cancelAnimationFrame(animationFrameId); // Stop current detection loop
                    const activeMediaSource = getActiveMediaSource();
                    if (activeMediaSource) {
                        animationFrameId = requestAnimationFrame(() => detectObjects(activeMediaSource));
                    }
                }
            });
        });

        // Speed threshold slider
        speedThresholdSlider.addEventListener('input', (event) => {
            speedThresholdValue.textContent = `${event.target.value} km/h`;
        });

        // Speed limit slider
        speedLimitSlider.addEventListener('input', (event) => {
            speedLimitValue.textContent = `${event.target.value} km/h`;
        });

        // Test sound buttons
        document.querySelectorAll('.test-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                playTestSound(event.target.dataset.sound);
            });
        });

        // Initial model load call (will be called after login check)
        loadModel();

        // Adjust canvas size on window resize
        window.addEventListener('resize', () => {
            const wrapper = canvas.parentElement;
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
        });

        // Initial canvas size adjustment
        window.onload = () => {
             // This ensures the canvas is sized correctly when the main content becomes visible
             // The login logic handles initial display, but this is good for subsequent resizes.
            const wrapper = canvas.parentElement;
            canvas.width = wrapper.clientWidth;
            canvas.height = wrapper.clientHeight;
        };

    </script>
</body>
</html>
